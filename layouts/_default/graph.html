{{ define "main" }}
<style>
    #full-screen-graph {
        position: fixed; /* Locks it to the screen, ignores parent containers */
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 10; /* Puts it behind the navbar (usually z-index 10+) */
    }
</style>

<div id="full-screen-graph"></div>

<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script type="text/javascript">
// 1. Helper to grab Blowfish colors
function getThemeColor(varName) {
    const style = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    return `rgb(${style})`;
}

const colorBg = getThemeColor('--color-neutral');        
const colorText = getThemeColor('--color-contrast-high');
const colorMuted = getThemeColor('--color-neutral-400'); 
const colorPrimary = getThemeColor('--color-primary-500');

// 2. Configuration for the Graph
var container = document.getElementById('full-screen-graph');

var options = {
    nodes: {
        shape: 'dot',
        font: { color: colorText, face: 'monospace', size: 16 },
        borderWidth: 2,
        color: {
            border: colorMuted,
            background: colorBg,
            highlight: { border: colorPrimary, background: colorPrimary }
        }
    },
    edges: {
        color: { color: colorMuted, opacity: 0.4 }, // Lower opacity for cleaner look
        width: 1,
        smooth: { type: 'continuous' }
    },
    physics: {
        stabilization: false,
        barnesHut: { 
            gravitationalConstant: -15000, // Stronger repulsion for clearer spacing
            springConstant: 0.04, 
            springLength: 100 
        }
    },
    interaction: { hover: true }
};

// 3. Main Data Fetching and Graph Construction
fetch("/members.json")
    .then(response => response.json())
    .then(data => {
        
        let nodes = [];
        let edges = [];
        let idCounter = 1;

        // --- A. Create the Main HUB Node ---
        const hubId = 0;
        nodes.push({
            id: hubId, 
            label: 'srdnlen', 
            group: 'hub', 
            value: 40, // Biggest node
            color: { background: colorPrimary, border: colorPrimary } // Highlight the hub
        });

        // --- B. Iterate through Categories in JSON ---
        for (const [categoryName, members] of Object.entries(data)) {
            
            // Create Category Node
            let catId = idCounter++;
            nodes.push({
                id: catId, 
                label: categoryName, 
                group: 'category', 
                value: 20 
            });

            // Link Category to Hub
            edges.push({from: hubId, to: catId});

            // --- C. Iterate through Members in this Category ---
            members.forEach(member => {
                let memId = idCounter++;
                
                // Determine Label (Prefer Nick, fallback to Name)
                let label = member.Nick ? member.Nick : member.Name;

                // Determine Image Path
                // Assumption: Images are in static/img/members/ if it's just a filename
                let imagePath = member.avatar;
                if (!imagePath.startsWith('http') && !imagePath.startsWith('/')) {
                    imagePath = '/img/members/' + member.avatar; 
                }

                // Create Member Node
                nodes.push({
                    id: memId,
                    label: label,
                    shape: 'circularImage',
                    image: imagePath,
                    value: 10,
                    title: `<b>${member.Name}</b><br>${member.role || member.position}` // Tooltip on hover
                });

                // Link Member to Category
                edges.push({from: catId, to: memId});
            });
        }

        // --- D. Initialize Network ---
        var graphData = { nodes: nodes, edges: edges };
        var network = new vis.Network(container, graphData, options);

        // Handle Resize
        setTimeout(() => { network.fit(); }, 100);
        window.addEventListener('resize', function() { network.fit(); });

        // Optional: Click event to open LinkedIn/Link
        network.on("click", function (params) {
            if (params.nodes.length === 1) {
                var nodeId = params.nodes[0];
                var clickedNode = nodes.find(n => n.id === nodeId);
                
                // Find the member data again to get the link (simplistic approach)
                // In a production app, you might store the URL in the node object directly
                // For now, this just visualizes.
            }
        });

    })
    .catch(error => console.error('Error loading members:', error));
</script>
{{ end }}
